external function LongInt POSNETHexToLong(string);external function val AbsoluteVal(val);SetLangMode(LangRussian,"RUS",0);procedure ErrorMessage(integer stat,integer error,integer reserv,var boolean done)beginstring 50 Message,reservmes;integer b1,b2,b3,b4,b5,b6,b7,b0,stat1,reserv1;val del;boolean majorerrf,statusf,resf;  Message = "";    if (error!=0) then begin    //done = false; //Edit***************************Sasha2,14:26 02.02.2015    switch(error) begin    case 1:Message = Message & "Ошибка принтера. ";    case 2:Message = Message & "Закончилась бумага. ";    case 4:Message = Message & "Сбой фискальной памяти. ";    case 6:Message = Message & "Снижения напряжения питания. ";    case 8:Message = Message & "Фискальная память переполнена. ";    case 10:Message = Message & "Не было персонализации. "; //Edit***************************Sasha2,12:47 15.10.2014    case 16:Message = Message & "Команда запрещена в данном режиме. "; majorerrf = true;    case 19:Message = Message & "Ошибка программирования логотипа. ";    case 20:Message = Message & "Неправильная длина строки. ";    case 21:Message = Message & "Неправильный пароль. ";    case 22:Message = Message & "Несуществующий номер (пароля, строки). ";    case 23:Message = Message & "Налоговая группа не существует или не установлена, налоги не вводились. ";    case 24:Message = Message & "Тип оплат не существует. ";    case 25:Message = Message & "Недопустимые коды символов. ";    case 26:Message = Message & "Превышение количества налогов. ";    case 27:Message = Message & "Отрицательная продажа больше суммы предыдущих продаж чека. ";    case 28:Message = Message & "Ошибка в описании артикула. ";    case 30:Message = Message & "Ошибка формата даты/времени. ";    case 31:Message = Message & "Превышение регистраций в чеке. ";    case 32:Message = Message & "Превышение разрядности вычисленной стоимости. ";    case 33:Message = Message & "Переполнение регистра дневного оборота. ";    case 34:Message = Message & "Переполнение регистра оплат. ";    case 35:Message = Message & "Сума выдано больше, чем в денежном ящике. ";    case 36:Message = Message & "Дата до даты последнего z-отчета. ";    case 37:Message = Message & "Открыт чек выплат, продажи запрещены. ";    case 38:Message = Message & "Открыт чек продаж, выплаты запрещены. ";    case 39:Message = Message & "Команда запрещена, чек не открыт. ";    case 41:Message = Message & "Команда запрещена до Z-отчета. ";    case 42:Message = Message & "Команда запрещена, не было чеков. ";    case 43:Message = Message & "Сдача с этой оплаты запрещена. ";    case 44:Message = Message & "Команда запрещена, чек открыт. ";    case 45:Message = Message & "Скидки\наценки запрещены, не было продаж. ";    case 46:Message = Message & "Команда запрещена после начала оплат. ";    case 47:Message = Message & "Переполнение контрольной ленты. "; //Edit***************************Sasha2,12:48 15.10.2014    case 48:Message = Message & "Неправильный номер данных КЛЕФ. "; //Edit***************************Sasha2,12:48 15.10.2014    case 50:Message = Message & "Команда запрещена, КЛЕФ не пустой. "; //Edit***************************Sasha2,12:48 15.10.2014    end;  end;      stat1 = stat;    b0 = 0;    b1 = 0;    b2 = 0;    b3 = 0;    b4 = 0;    b5 = 0;    b6 = 0;    b7 = 0;        if(stat>0)then begin      //done = false;    end;        if(stat1>=128) then begin      b7=1;      stat1 = stat1-128;      Message = Message & "Команда не существует или запрещена в данном режиме. ";      statusf = true;    end;        if(stat1>=64) then begin      b6=1;      stat1 = stat1-64;       Message = Message & "Снижение рабочего напряжения питания (!проверьте блок питания). ";       statusf = true;    end;        if(stat1>=32) then begin      b5=1;      stat1 = stat1-32;      Message = Message & "Превышение продолжительности смены (!Сделайт Z-отчет). ";    end;        if(stat1>=16) then begin      b4=1;      stat1 = stat1-16;      Message = Message & "Ошибка индикатора (!Подключите индикатор). ";    end;        if(stat1>=8) then begin      b3=1;      stat1 = stat1-8;      Message = Message & "Неправильная дата или ошибка часов. ";    end;        if(stat1>=4) then begin      b2=1;      stat1 = stat1-4;      Message = Message & "Ошибка или переполнение фискальной памяти. ";    end;        if(stat1>=2) then begin      b1=1;      stat1 = stat1-2;      Message = Message & "Превышение продолжительности хранения данных в КЛЕФ (!Проверьте модем). ";    end;        if(stat1>=1) then begin      b0=1;      Message = Message & "Принтер не готов. ";    end;    //messageBox(0,stat &"_"& b7 & b6 & b5 & b4 & b3 & b2 & b1 & b0);    	reserv1 = reserv;    if(reserv1>=128) then begin      reserv1 = reserv1-128;      //reservmes = reservmes & "ЭККР не персонализирован; ";    end;        if(reserv1>=64) then begin      reserv1 = reserv1-64;       reservmes = reservmes & "Открыт чек. ";    end;        if(reserv1>=32) then begin      reserv1 = reserv1-32;      //reservmes = reservmes & "Смена открыта. ";    end;        if(reserv1>=16) then begin      reserv1 = reserv1-16;     // reservmes = reservmes & "Принтер фискализирован. ";    end;        if(reserv1>=8) then begin      reserv1 = reserv1-8;      //reservmes = reservmes & "Чек: продажи/выплаты (0/1). ";    end;        if(reserv1>=4) then begin      reserv1 = reserv1-4;      if (b0==1) then begin      	reservmes = reservmes & "Отсутствие бумаги. ";      end;    end;        if(reserv1>=2) then begin      reserv1 = reserv1-2;      reservmes = reservmes & "Состояние аварии (команда завершится после устранения ошибки). ";    end;        if(reserv1>=1) then begin      reservmes = reservmes & "Открыт чек служебного отчета. ";    end;    if (NonBlank(reservmes)) then begin  	Message = Message & Chr(13) & reservmes;   end;    if (majorerrf and statusf) then begin    goto LErrorMessage;  end;    if(nonblank(Message)) then begin    MessageBox(0,Message);  end;LErrorMessage:;return;end;procedure NumToHex(string instr,var string res)BEGIN  string 16 hexs;  LongInt l,i;  string 255 tstr;    res = "";  l = FirstInRange(instr,10);  hexs = "0123456789ABCDEF";  for (i=0;i<8;i=i+1) begin    tstr = tstr & Mid(hexs,BitAnd(l,15),1);    l = l/16;  end;  for (i=len(tstr);i>=0;i=i-1) begin    res = res & Mid(tstr,i,1);  end;    RETURN;END;procedure CalcStr (var string str,var integer sum)begin  string 25 stroka,newstroka;string 1 char;integer i,c,c0;newstroka = "";  for (i=0;i<len(str);i=i+1) begin    c=0;    char = mid(str,i,1);        c = asc(char);    c0=c;      if (c>=1040 and c<1088) then begin//    if (c>158) then begin          c = c - 912;      end;            if (c>=1088 and c<=1103) then begin          c = c - 864;      end;            if(c>1025) begin        switch(c) begin        case 1025: c = 240;        case 1105: c = 241;        case 1028: c = 242;        case 1108: c = 243;        case 1031: c = 244;        case 1111: c = 245;        case 1168: c = 246;        case 1169: c = 247;        case 8470: c = 252;//№        case 1110: c = 105;        case 1030: c = 73;        end;      end;            if((c> 175 and c< 224) or (c> 252)) then begin        c = 32;      end;      if(c==16) then begin        newstroka = newstroka & chr(c);               end;      //if (c==32) then begin c=95; end;      newstroka = newstroka & chr(c);    //end;        sum = sum + c;  end;   str = newstroka;return;end;procedure CalcInt (var string int,var integer sum)beginstring 5 resint;integer c1,c2,c3,c4;string 1 char1, char2, char3, char4;NumToHex(evaltoval(int),resint);c1 = POSNETHexToLong(mid(resint,0,1))*16+POSNETHexToLong(mid(resint,1,1));char1 = chr(c1);if(c1==16) then begin  char1 = char1 & chr(c1);end;c2 = POSNETHexToLong(mid(resint,2,1))*16+POSNETHexToLong(mid(resint,3,1));char2 = chr(c2);if(c2==16) then begin  char2 = char2 & chr(c2);end;c3 = POSNETHexToLong(mid(resint,4,1))*16+POSNETHexToLong(mid(resint,5,1));char3 = chr(c3);if(c3==16) then begin  char3 = char3 & chr(c3);end;c4 = POSNETHexToLong(mid(resint,6,1))*16+POSNETHexToLong(mid(resint,7,1));char4 = chr(c4);if(c4==16) then begin  char4 = char4 & chr(c4);end;int = "";int = char4 & char3 & char2 & char1;sum = sum+c1+c2+c3+c4;return;end;procedure CalcInt1 (var string int,var integer sum)beginstring 5 resint;integer c1,c2,c3,c4;string 1 char1, char2, char3, char4;NumToHex(evaltoval(int),resint);c1 = POSNETHexToLong(mid(resint,0,1))*16+POSNETHexToLong(mid(resint,1,1));c1=128+c1;char1 = chr(c1);if(c1==16) then begin  char1 = char1 & chr(c1);end;c2 = POSNETHexToLong(mid(resint,2,1))*16+POSNETHexToLong(mid(resint,3,1));char2 = chr(c2);if(c2==16) then begin  char2 = char2 & chr(c2);end;c3 = POSNETHexToLong(mid(resint,4,1))*16+POSNETHexToLong(mid(resint,5,1));char3 = chr(c3);if(c3==16) then begin  char3 = char3 & chr(c3);end;c4 = POSNETHexToLong(mid(resint,6,1))*16+POSNETHexToLong(mid(resint,7,1));char4 = chr(c4);if(c4==16) then begin  char4 = char4 & chr(c4);end;int = "";int = char4 & char3 & char2 & char1;sum = sum+c1+c2+c3+c4;return;end;procedure CommandString(string filename, integer i,integer code,string param,integer sum,var boolean done)begin  string 100 command,command1,command2,command3,comsum,command4,inparam;  integer sum1;  string 5 hex;  string 5 sumstr;  string 1 char,char1;  integer repetitionqty,int,ii,int1,stat,errflag,int2,int3,int4,int5,int6,DLE_skip;  boolean testf,testf1,dle_stx_flag;  string 255 error;    logtext(0,filename & "_" & i & "_" & code & "_" & param & "_" & sum & "_" & done);    if(done) then begin    inparam = param;    command = "";    command1 = "";    command2 = "";    command3 = "";        command1 = command1 & chr(16) & chr(2);    command2 = command2 & chr(i);    if (i==16) then begin      command2 = command2 & chr(i);    end;    command3 = command3 & chr(code);    if (code==16) then begin      command3 = command3 & chr(code);    end;        if (blank(param)) then begin      inparam = chr(0);    end;       command4 = command4 & inparam;        comsum = command2 & command3 & command4;    sum1 = i+code+sum;        while(sum1>256) begin    sum1 = sum1-256;    end;        sumstr = chr(256-sum1);    //Messagebox(0,256-sum1);    /*if(asc(sumstr) == 16) then begin       sumstr = sumstr & sumstr;      messagebox(0,1);    end;*/        if(256-sum1 == 16) then begin      sumstr = sumstr & sumstr;      //messagebox(0,1);    end;        command = command1 & comsum & sumstr & chr(16) & chr(3);	ii=0; //Edit***************************Sasha2,15:22 27.10.2014	repetitionqty = 5; //Edit***************************Sasha2,15:21 27.10.2014	LRepeatCommand:; //Edit***************************Sasha2,15:20 27.10.2014      	OutComPort(0,command);  	millisleep(50);  	       testf = true;    testf1=true;    dle_stx_flag = true; //Edit***************************Sasha2,17:38 27.10.2014	  DLE_skip = 0; //Edit***************************Sasha2,9:11 28.10.2014    //millisleep(150);    while(testf) begin      char = ReadComPort(0,1);      int = asc(char);      //addtexttoarea(char,test);            if(int==6 and testf1) then begin      	millisleep(150);        testf1 = false;      end;            if(int==21 and testf1) then begin        testf = false;      end;            if(int==22) then begin        millisleep(200);      end;            if(int==3 and int1==16 and int2!=16) or (int==3 and int1==16 and int2==16 and int3==16) then begin //Edit***************************Sasha2,15:20 27.10.2014        testf = false;      end;            if(blank(char)) then begin        testf = false;        ii=ii+1;        if (ii<=repetitionqty) then begin        	goto LRepeatCommand; //Edit***************************Sasha2,15:21 27.10.2014        end;      end;            if((int6==16) and (int5==2)) then begin //Edit***************************Sasha2,15:20 27.10.2014        if((int2!=0 and int2!=16) or int1!=0) then begin //Edit***************************Sasha2,15:20 27.10.2014          ErrorMessage(int2,int1,int,done); //Edit***************************Sasha2,15:20 27.10.2014        end;      end;            if (dle_stx_flag and int1==16 and int==2) then begin      	  dle_stx_flag = false; //Edit***************************Sasha2,17:54 27.10.2014      end;            if (dle_stx_flag==false and int==16 and int1==16 and DLE_skip<1) then begin      	  DLE_skip = 2; //Edit***************************Sasha2,9:48 28.10.2014      	  goto LSkipIntShifting; //Edit***************************Sasha2,17:54 27.10.2014      end;            int6 = int5; //Edit***************************Sasha2,15:20 27.10.2014      int5 = int4;      int4 = int3;      int3 = int2;      int2 = int1;      int1 = int;      LSkipIntShifting:; //Edit***************************Sasha2,18:03 27.10.2014	  	  DLE_skip = DLE_skip - 1; //Edit***************************Sasha2,9:13 28.10.2014    end;        if(ii>repetitionqty) then begin    	//done = false; //Edit***************************Sasha2,16:50 27.10.2014    	MessageBox(0,"Проблема связи с ЭККР"); //Edit***************************Sasha2,15:20 27.10.2014    end;  end;     return;end;procedure advancepaper(string filename,integer i,var boolean done)begininteger k;  for(k=0;k<i;k=k+1)begin    CommandString(filename,k+2,14,"",0,done);  end;return;end;procedure CashIn(string filename,string cash,var boolean done)begininteger sum;string 20 CashStr;    CashStr = AbsoluteVal(evaltoval(cash));    CalcInt(CashStr,sum);    if (evaltoval(cash)>=0) then begin  	CommandString(filename,2,16,CashStr,sum,done);  end else begin  	CommandString(filename,2,24,CashStr,sum,done);  end;return;end;procedure periodreport(string filename,string param,var boolean done)begininteger sd,sm,sy,ed,em,ey,sum;string 20 prm;    sd = evaltoval(mid(param,0,2));  sm = evaltoval(mid(param,2,2));  sy = evaltoval(mid(param,4,2));    if(sd>29) then begin    sd = sd+6;   end;  if(sm>29) then begin    sm = sm+6;   end;  if(sy>29) then begin    sy = sy+6;   end;    if(sd>19) then begin    sd = sd+6;   end;  if(sm>19) then begin    sm = sm+6;   end;  if(sy>19) then begin    sy = sy+6;   end;    if(sd>9) then begin    sd = sd+6;   end;  if(sm>9) then begin    sm = sm+6;   end;  if(sy>9) then begin    sy = sy+6;   end;    ed = evaltoval(mid(param,7,2));  em = evaltoval(mid(param,9,2));  ey = evaltoval(mid(param,11,2));    if(ed>29) then begin    ed = ed+6;   end;  if(em>29) then begin    em = em+6;   end;  if(ey>29) then begin    ey = ey+6;   end;    if(ed>19) then begin    ed = ed+6;   end;  if(em>19) then begin    em = em+6;   end;  if(ey>19) then begin    ey = ey+6;   end;    if(ed>9) then begin    ed = ed+6;   end;  if(em>9) then begin    em = em+6;   end;  if(ey>9) then begin    ey = ey+6;   end;    prm = chr(0) & chr(0) & chr(sd) & chr(sm) & chr(sy) & chr(ed) & chr(em) & chr(ey);  CalcInt(prm,sum);  CommandString(filename,2,17,prm,sum,done);  return;end;procedure periodreportshort(string filename,string param,var boolean done)begindate MyDate;integer sd,sm,sy,ed,em,ey,sum;string 20 prm;    sd = evaltoval(mid(param,0,2));  sm = evaltoval(mid(param,2,2));  sy = evaltoval(mid(param,4,2));    if(sd>29) then begin    sd = sd+6;   end;  if(sm>29) then begin    sm = sm+6;   end;  if(sy>29) then begin    sy = sy+6;   end;    if(sd>19) then begin    sd = sd+6;   end;  if(sm>19) then begin    sm = sm+6;   end;  if(sy>19) then begin    sy = sy+6;   end;    if(sd>9) then begin    sd = sd+6;   end;  if(sm>9) then begin    sm = sm+6;   end;  if(sy>9) then begin    sy = sy+6;   end;    ed = evaltoval(mid(param,7,2));  em = evaltoval(mid(param,9,2));  ey = evaltoval(mid(param,11,2));    if(ed>29) then begin    ed = ed+6;   end;  if(em>29) then begin    em = em+6;   end;  if(ey>29) then begin    ey = ey+6;   end;    if(ed>19) then begin    ed = ed+6;   end;  if(em>19) then begin    em = em+6;   end;  if(ey>19) then begin    ey = ey+6;   end;    if(ed>9) then begin    ed = ed+6;   end;  if(em>9) then begin    em = em+6;   end;  if(ey>9) then begin    ey = ey+6;   end;    prm = chr(0) & chr(0) & chr(sd) & chr(sm) & chr(sy) & chr(ed) & chr(em) & chr(ey);  CalcStr(prm,sum);  CommandString(filename,2,26,prm,sum,done);return;end;procedure PrintReciept(string filename,string param,var boolean done)beginval cash,term,rebeat,ai,present,costval,cost,cashint,termint,presentint;integer quant,vat,lines,num;integer sum,mtrw,j,i,lenth,k,l;string 50 name,serial,comstr,comint,coststr,numstr,cashstr,termstr,lenstr,serialstr,text,presentstr,pdvstr;string 1 c1,c2,c3,c4;Record IVCashVc IVCashr;row IVCashVc IVCashrw;Record INVc INr;Record INNnum1Vc INNr;record VATCodeBlock vatr;row VATCodeBlock vatrw;string 100 newitname;  blockload(vatr);  IVCashr.SerNr = stringtolongint(param);    if (ReadFirstMain(IVCashr,1,false))then begin  //if (IVCashr.SerNr>0)then begin       cash = IVCashr.CashValue;    term = IVCashr.RecValue;    present = IVCashr.RecValue2;    lines = MatRowCnt(IVCashr);				    for(i=0;i<lines;i=i+1) begin      matrowget(IVCashr,i,IVCashrw);      if(nonblank(IVCashrw.ArtCode))then begin        INr.Code = IVCashrw.ArtCode;        if(readfirstmain(INr,1,true))begin end;        vat=1;        mtrw=matrowcnt(vatr);        for (j=0;j<mtrw;j=j+1) begin          matrowget(vatr,j,vatrw)          if (vatrw.VATCode==INr.VATCode) then begin            if (vatrw.ExVatpr==0) then begin vat=0;            end;          end;        end;                        newitname = "";        name = INr.Name;        name = IVCashrw.Spec;// Edit ************************** Wednesday, 22 April 2015 14:53:48        lenth = len(name);        for(k=0;k<lenth;k=k+1) begin          if(asc(mid(name,k,1))<32) then begin            newitname = newitname & "";          end else begin            newitname = newitname & mid(name,k,1);          end;        end;                INNr.ArtCode=INr.Code;        if (readfirstMain(INNr,1,true)) then begin end;                if (len(newitname)>50) then begin          name=left(newitname,50);        end        else begin          name=newitname;        end;                if (len(newitname)<50) then begin          for(l=len(newitname);l<50;l=l+1) begin            name = name & " ";	          end;        end;                        num = INNr.ItemNo;        num = stringtoint(gethour(currenttime) & getminute(currenttime) & getsecond(currenttime)& "0" & i);// Edit ************************** Tuesday, 3 March 2015 20:36:51        quant = IVCashrw.Quant;        if(quant<0)then begin          quant = -quant;        end;                cost = IVCashrw.Sum*100;        if(cost<0)then begin          cost = -cost;        end;        //rebeat = evaltoval(GetTabTextFromArea(0,(7*i)+9,AFile));        serial = IVCashrw.SerialNr;        if((cash>0)or(term>0)or(present>0)) then begin          coststr = ValToString(cost/quant,M4Val,"",".",0);          sum = 0;          CalcInt(coststr,sum);//----          numstr = ValToString(num,M4Val,"",".",0);          CalcInt(numstr,sum);//-----         lenth = len(name); // Edit ************************** Tuesday, 27 April 2010 2:04:17 PM          CalcStr(name,sum);//-------          switch(vat) begin            case 0: vat = 133;            case 1: vat = 128;          end;          lenstr = chr(lenth);          if(lenth == 16) then begin            lenstr = lenstr & chr(lenth);          end;                    comstr = chr(quant) & chr(0) & chr(0) & chr(0) & coststr & chr(vat) & lenstr & name & numstr;          CommandString(filename,2+i,18,comstr,sum+lenth+quant+vat,done);                    sum = 0;          CalcStr(serial,sum);          lenth = len(serial);          lenstr = chr(lenth);          if(lenth == 16) then begin            lenstr = lenstr & chr(lenth);          end;                    millisleep(125);                    CommandString(filename,1,11,lenstr & serial,sum+lenth,done);        end;        if((cash<0)or(term<0)or(present<0)) then begin          coststr = ValToString(cost/quant,M4Val,"",".",0);          sum = 0;          CalcInt(coststr,sum);//----          numstr = ValToString(num,M4Val,"",".",0);          CalcInt(numstr,sum);//-----          lenth = len(name);// Edit ************************** Tuesday, 27 April 2010 2:10:52 PM          CalcStr(name,sum);//-------          switch(vat) begin            case 0: vat = 133;            case 1: vat = 128;          end;          lenstr = chr(lenth);          if(lenth == 16) then begin            lenstr = lenstr & chr(lenth);          end;          comstr = chr(quant) & chr(0) & chr(0) & chr(0) & coststr & chr(vat) & lenstr & name & numstr;          CommandString(filename,2+i,8,comstr,sum+lenth+quant+vat,done);          sum = 0;          CalcStr(serial,sum);          lenth = len(serial);          lenstr = chr(lenth);          if(lenth == 16) then begin            lenstr = lenstr & chr(lenth);          end;                    millisleep(125);                    CommandString(filename,1,11,lenstr & serial,sum+lenth,done);        end;      end;    end;    if((cash<0)or(term<0)or(present<0)) then begin      sum = 0;      Serial = " ";      serial = chr(len(serial)) & serial;      CalcStr(serial,sum);      millisleep(125);      CommandString(filename,3,11,serial,sum,done);      sum = 0;      serial = USetStr(13086);      serial = chr(len(serial)) & serial;      CalcStr(serial,sum);      millisleep(125);      CommandString(filename,2,11,serial,sum,done);    end;			sum = 0;      comstr = "";      if(AbsoluteVal(present)>0) then begin        presentint = AbsoluteVal(present*100);        presentstr = "";        presentstr = ValToString(presentint,M4Val,"",".",0);        CalcInt1(presentstr,sum);        comstr = chr(3) & presentstr & chr(0) & chr(0);        CommandString(filename,3+i,35,comstr,sum+3,done);      end;      millisleep(125);      sum = 0;      comstr = "";      if(AbsoluteVal(cash)>=0) then begin      //stopalert(cash);        cashint = AbsoluteVal(cash*100);        cashstr = "";        cashstr = ValToString(cashint,M4Val,"",".",0);        CalcInt(cashstr,sum);        comstr = chr(3) & cashstr & chr(0) & chr(0);        CommandString(filename,4+i,20,comstr,sum+3,done);      end;      sum = 0;      comstr = "";      if(AbsoluteVal(term)>0) then begin        termint = AbsoluteVal(term*100);        termstr = "";        termstr = ValToString(termint,M4Val,"",".",0);        CalcInt(termstr,sum);        comstr = chr(0) & termstr & chr(0) & chr(0);        CommandString(filename,2+i,20,comstr,sum,done);      end;  end;return;end;procedure SetTimeOnPrinter(string filename, var boolean done)begin  string 100 command;	integer h,m,s,sum;		h = GetHour(CurrentTime);	m = GetMinute(CurrentTime);	s = GetSecond(CurrentTime);		if (h>19) then begin h = h+6; end;	if (h>9) then begin h = h+6; end;			if (m>59) then begin m = m+6; end;	if (m>49) then begin m = m+6; end;	if (m>39) then begin m = m+6; end;	if (m>29) then begin m = m+6; end;	if (m>19) then begin m = m+6; end;	if (m>9) then begin m = m+6; end;		if (s>59) then begin s = s+6; end;	if (s>49) then begin s = s+6; end;	if (s>39) then begin s = s+6; end;	if (s>29) then begin s = s+6; end;	if (s>19) then begin s = s+6; end;	if (s>9) then begin s = s+6; end;			command = chr(h) & chr(m) & chr(s);	  CalcStr(command,sum);  CommandString(filename,2,4,command,sum,done);		return;end;global procedure prt(string comand1,string param1,var boolean successf)begininteger wn,i,k,d;boolean filef,done;record INVc INr;record RcVc RepSpec;integer lenth,sum;string 255 newparam,SendStr;string 255 param, comand; //Temp String Paramstring 255 filename;record LocalMachineBlock LMb;area SendArea;record IVCashVc IVr;record SerPrintBlock SPb; //Edit***************************Sasha2,17:35 02.10.2014 blockload(LMb);blockload(SPb); //Edit***************************Sasha2,17:35 02.10.2014                     comand = comand1;param = param1;filef = false;filename = "";     k=0;    lenth = len(param);        if(mid(param,0,2)==".\\" )then begin k=2; end;        for(i=k;i<lenth;i=i+1) begin      if (mid(param,i,1)=="\\") then begin        newparam = newparam & "/";      end else begin        newparam = newparam & mid(param,i,1);      end;    end;    filef = true;    //millisleep(150);        if(blank(SPb.Port) or len(SPb.Port)<4)then begin    	filef = false;    end;        if(filef) then begin          if (OpenComPort(0,SPb.Port,9600,-1,8,1,kFlowControlDefault)==0) then begin      	done = false;      	goto Lprt;      end;             done = true;      CommandString(filename,1,1,"",0,done);      switch(comand) begin        case "xreport":       CommandString(filename,2,9,chr(0) & chr(0),0,done);                case "zreport":       CommandString(filename,2,13,chr(0) & chr(0),0,done);                        case "advancepaper":  advancepaper(filename,evaltoval(param),done);                case "cashin":        CashIn(filename,param,done);                 case "UStroke":       param = chr(0) & chr(len(param)) & param;                              CalcStr(param,sum);                              CommandString(filename,2,27,param,sum,done);                case "DStroke":       param = chr(1) & chr(len(param)) & param;                              CalcStr(param,sum);                              CommandString(filename,2,27,param,sum,done);                case "CStroke":       CommandString(filename,2,27,chr(0) & chr(0) & chr(0),0,done);                              //millisleep(35);                              CommandString(filename,3,27,chr(1) & chr(0) & chr(0),1,done);                case "print":         param = chr(len(param)) & param;                              CalcStr(param,sum);                              CommandString(filename,2,40,param,sum,done);                              //millisleep(125);                              CommandString(filename,3,40,chr(255) & chr(0),255,done);                                      case "nullcheck":     sum = 0;                              param = chr(len(param)) & param;                              CalcStr(param,sum);                              CommandString(filename,2,11,param,sum,done);                              //millisleep(130);                              param = "0";                              sum = 0;                              CalcInt(param,sum);                              CommandString(filename,3,20,chr(0) & param & chr(0) & chr(0),sum,done);                case "printreciept":  PrintReciept(filename,param,done);                case "periodreport":  PeriodReport(filename,param,done);        case "periodreportshort": PeriodReportShort(filename,param,done);        case "cancel":        CommandString(filename,2,15,"",0,done);                case "bigreport":     param = chr(0) & chr(0);                              CommandString(filename,2,10,param,0,done);        case "settimeprinter":SetTimeOnPrinter(filename,done);      end;Lprt:;       CloseComPort(0);    end;        successf = done;return;end;function integer LastINNum()beginrecord INNnum1Vc INNr;integer res;    res = -1;  INNr.ArtCode = "";    INNr.ItemNo = 999;  if(ReadLastKey("ItemNo",INNr,1,false)) then begin  res = INNr.ItemNo;    end;  if(res==-1)then begin    res = 0;  end;    LastINNum = res;  returnend;globalupdating function boolean PrintFiscalReceipt(record IVCashVc IVCashr) begin  string 255 fname;  record INNnum1Vc INNr;  record INNnum1Vc INN2r;  row IVCashVc IVCashrw;  integer mtrw,i,last;  boolean testf,successf;    successf = false;  mtrw = matrowcnt(IVCashr);  For(i=0;i<mtrw;i=i+1) begin	  matrowget(IVCashr,i,IVCashrw);	  If(nonblank(IVCashrw.ArtCode)) then begin	    INNr.ArtCode = IVCashrw.ArtCode;	    if(readfirstmain(INNr,1,true) and (INNr.ArtCode==IVCashrw.ArtCode))then begin	    end else begin	      RecordNew(INN2r);	      INN2r.ArtCode = IVCashrw.ArtCode;	      INN2r.ItemNo = LastINNum + 1;	      testf = RecordInsert(INN2r,false);	    end;    end;   end;   prt("printreciept",IVCashr.SerNr,successf);    PrintFiscalReceipt = successf;return;end;