remote function Boolean StockMovVc_PasteArtCode(var record StockMovVc,Integer,Integer,var array string);remote function Boolean StockMovVc_PasteQuant(var record StockMovVc,Integer);remote procedure StockMovVc_PasteSerialNr(var record StockMovVc,Integer,var array string);external procedure ORVc_PasteQuant(var record ORVc,Integer,Boolean,var Boolean); //Edit***************************Sasha2,12:00 23.07.2015external function Boolean ORDchrsum(var record ORVc,Integer); //Edit***************************Sasha2,12:02 23.07.2015external procedure ORDchsum(var record ORVc,Integer); //Edit***************************Sasha2,12:02 23.07.2015external procedure ORSumup(var record ORVc); //Edit***************************Sasha2,12:02 23.07.2015SetLangMode(LangRussian,"RUS",0); //Edit***************************Sasha2,9:41 02.10.2014global //Edit***************************Sasha2,17:05 31.10.2014 {updating procedure RecalcORShops(string ORsernrs)begin  record ORvc ORr;  row ORVc ORrw;  record SHVc SHr;  row SHVc SHrw;  record RetVc Retr;  row RetVc Retrw;  record StockMovVc StockMovr;  row StockMovVc StockMovrw;  LongInt first,last;  boolean TrHs,testf,TrHs1,testf1,setmark,ratiof;  integer rwcnt,i;    ratiof = false;  if (nonblank(ORsernrs)) then begin  	first = FirstInRange(ORsernrs,10);  	last = LastInRange(ORsernrs,10);  	if (first>-1) then begin  		ORr.SerNr = first;  		ratiof = true;  	end;  end;    TrHs = true;  while (LoopMain(ORr,1,TrHs)) begin  	testf = true;  	if (ratiof and last==first and ORr.SerNr>first) then begin TrHs = false;testf = false; end;  	if (ratiof and last!=first and ORr.SerNr>last) then begin TrHs = false;testf = false; end;  	if (ORr.OrderClass!="Shops") then begin testf = false; end;  	  	if (testf) then begin	  		rwcnt=MatRowCnt(ORr);  		for (i=0;i<rwcnt;i=i+1) begin  			MatRowGet(ORr,i,ORrw);  			ORrw.Shopd = 0;  			MatRowPut(ORr,i,ORrw);  		end;  		setmark = false;  	  		StockMovr.OrderNr = ORr.SerNr;  		TrHs1 = true;  		while (LoopKey("OrderNr",StockMovr,1,TrHs1)) begin  			testf1 = true;  			if(StockMovr.OrderNr!=ORr.SerNr) then begin testf1 = false; TrHs1 = false; end;				if (/*StockMovr.OrdFlag!=1 or*/ StockMovr.OKFlag!=1) then begin testf1 = false; end;							if (testf1) then begin				rwcnt=MatRowCnt(StockMovr);				for (i=0;i<rwcnt;i=i+1) begin										MatRowGet(StockMovr,i,StockMovrw);					if (StockMovrw.ORRow>-1) then begin						MatRowGet(ORr,StockMovrw.ORRow,ORrw);						if (StockMovrw.ArtCode==ORrw.ArtCode) then begin							if (StockMovr.ToLocation==ORr.Location) then begin								ORrw.Shopd = ORrw.Shopd + StockMovrw.Quant;							end;							if (StockMovr.FrLocation==ORr.Location) then begin								ORrw.Shopd = ORrw.Shopd - StockMovrw.Quant;															end;							MatRowPut(ORr,StockMovrw.ORRow,ORrw);						end;					end;				end;			end;		end; RESETLOOP(StockMovr);				SHr.OrderNr = ORr.SerNr;		TrHs1 = true;		while (LoopKey("OrderKey",SHr,1,TrHs1)) begin			testf1 = true;			if(SHr.OrderNr!=ORr.SerNr) then begin testf1 = false; TrHs1 = false; end;			if (SHr.OKFlag!=1 or SHr.Location!=ORr.Location) then begin testf1 = false; end;			if (testf1) then begin				rwcnt=MatRowCnt(SHr);				for (i=0;i<rwcnt;i=i+1) begin					MatRowGet(SHr,i,SHrw);					if (SHrw.OrdRow>-1) then begin						MatRowGet(ORr,SHrw.OrdRow,ORrw);						if (SHrw.ArtCode==ORrw.ArtCode) then begin							ORrw.Shopd = ORrw.Shopd - SHrw.Ship;							MatRowPut(ORr,SHrw.OrdRow,ORrw);						end;					end;				end;			end;		end; RESETLOOP(SHr);				Retr.OrdNr = ORr.SerNr;		TrHs1 = true;		while (LoopKey("OrdNr",Retr,1,TrHs1)) begin			testf1 = true;			if(Retr.OrdNr!=ORr.SerNr) then begin testf1 = false; TrHs1 = false; end;			if (Retr.OKFlag!=1 or Retr.Location!=ORr.Location) then begin testf1 = false; end;			if (testf1) then begin				rwcnt=MatRowCnt(Retr);				for (i=0;i<rwcnt;i=i+1) begin					MatRowGet(Retr,i,Retrw);					if (Retrw.OrdRow>-1) then begin						MatRowGet(ORr,Retrw.OrdRow,ORrw);						if (Retrw.ArtCode==ORrw.ArtCode) then begin							ORrw.Shopd = ORrw.Shopd + Retrw.Quant;							MatRowPut(ORr,Retrw.OrdRow,ORrw);						end;					end;				end;			end;		end; RESETLOOP(Retr);				rwcnt=MatRowCnt(ORr);  		for (i=0;i<rwcnt;i=i+1) begin  			MatRowGet(ORr,i,ORrw);  			if (setmark==false and ORrw.Shopd<>0) then begin  				setmark = true;  				i = rwcnt;  			end;  		end;  		  		if (setmark) then begin  			ORr.ShopsMark = 1;  		end else begin  			ORr.ShopsMark = 0;	  		end;  		logtext(0,"RecordStore");  		RECORDSTORE(ORr,true);	  	end;  end;  return;end; //Edit***************************Sasha2,17:05 31.10.2014 }globalprocedure CollectSerials(var record StockMovVc StockMov3r,string item,string serialnr,integer qty)begin  Integer i,rwcnt,pos;  row StockMovVc StockMov3rw;  string 50 serial;  Boolean foundf;    foundf = false;  serial = serialnr;  rwcnt = MatRowCnt(StockMov3r);  for (i=0;i<rwcnt;i=i+1) begin  	MatRowGet(StockMov3r,i,StockMov3rw);    if (item==StockMov3rw.ArtCode and serial==StockMov3rw.SerialNr) then begin      pos = i;      foundf = true;      i = rwcnt;    end;  end;  if (foundf==false) then begin    pos = rwcnt;    StockMov3rw.SerialNr = serial;    StockMov3rw.ArtCode = item;    StockMov3rw.Quant = 0;  end;  StockMov3rw.Quant = StockMov3rw.Quant + qty;  MatRowPut(StockMov3r,pos,StockMov3rw);  return;end;global //Edit***************************Sasha2,15:00 26.08.2014 {updating procedure SendToShopsFromORVcRoutine(var record StockMovVc StockMov2r,record ORVc ORr,var integer res,integer company)BEGIN row ORVc ORrw; record StockMovVc StockMovr; row StockMovVc StockMovrw, StockMov2rw; record INVc INr; record RetVc Retr; row RetVc Retrw; integer rwcnt,i,rwcnt1,j,sercnt,k,rownr; val itemqty; Boolean StockMovexists,TrHs,testf; array string 255 aWarning;  	 	rownr = 0;  		if (ORr.OrderClass=="Shops") then begin  			rwcnt=MatRowCnt(ORr);  			StockMovr.OrderNr = ORr.SerNr;  			StockMovexists = ReadFirstKey("OrderNr",StockMovr,1,true);  			for (i=0;i<rwcnt;i=i+1) begin  				MatRowGet(ORr,i,ORrw);  				if ((ORrw.Quant - ORrw.Shipd2) > 0 and NonBlank(ORrw.ArtCode)) then begin  					itemqty = 0;  					if (StockMovexists) then begin  						TrHs = true;  						while (LoopKey("OrderNr",StockMovr,1,TrHs)) begin  							testf = true;  							if(StockMovr.OrderNr!=ORr.SerNr)then begin testf = false; TrHs = false; end;  							if (testf) then begin  								rwcnt1=MatRowCnt(StockMovr);	  							for (j=0;j<rwcnt1;j=j+1) begin	  							MatRowGet(StockMovr,j,StockMovrw);	  							if (/*StockMovr.OrdFlag==1 and*/ StockMovr.OKFlag==1 and StockMovrw.ArtCode==ORrw.ArtCode and StockMovrw.ORRow==i) then begin	  								if (StockMovr.ToLocation==ORr.Location) then begin	  									itemqty = itemqty + StockMovrw.Quant;	  								end;	  								if (StockMovr.FrLocation==ORr.Location) then begin	  									itemqty = itemqty - StockMovrw.Quant;	  								end;	  							end;	  						end;  							end;	  						  						end; RESETLOOP(StockMovr);  						  						Retr.OrdNr = ORr.SerNr;  						TrHs = true;  						while (LoopKey("OrdNr",Retr,1,TrHs)) begin  							testf = true;  							if (Retr.OrdNr!=ORr.SerNr) then begin TrHs = false; testf = false; end;  							if (Retr.OKFlag!=1 or Retr.Location!=ORr.Location) then begin testf = false; end;  								if (testf) then begin  									rwcnt1=MatRowCnt(Retr);  									for (j=0;j<rwcnt1;j=j+1) begin  										MatRowGet(Retr,j,Retrw);  										testf = true;  										if (Retrw.ArtCode!=ORrw.ArtCode or Retrw.OrdRow!=i) then begin testf = false; end;  										if (testf) then begin  					  						itemqty = itemqty + Retrw.Quant;  										end;  									end;  								end;  						end; RESETLOOP(Retr);  					end;  					if (itemqty < ORrw.Quant) then begin  						INr.Code = ORrw.ArtCode;  						ReadFirstMain(INr,1,true);  						if (INr.SerNrf == 1) then begin  							sercnt = ORrw.Quant - itemqty;  							for (k=0;k<sercnt;k=k+1) begin  								StockMov2rw.ArtCode = ORrw.ArtCode;  								MatRowPut(StockMov2r,rownr,StockMov2rw);  								if (!StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning)) then begin  									res = 0;  									goto LOut;  								end;  								MatRowGet(StockMov2r,rownr,StockMov2rw);		  						StockMov2rw.Spec = ORrw.Spec;		  						StockMov2rw.OrdQuant = 1;		  						StockMov2rw.Quant = 1;		  						MatRowPut(StockMov2r,rownr,StockMov2rw);		  						if (!StockMovVc_PasteQuant(StockMov2r,rownr)) then begin		  							res = 0;  									goto LOut;		  						end;		  						MatRowGet(StockMov2r,rownr,StockMov2rw);		  						//StockMov2rw.OldPrice = ORrw.BasePrice;		  						//StockMov2rw.NewPrice = ORrw.BasePrice;		  						StockMov2rw.ORRow = i;		  						//messagebox(0,i);		  						//logtext(0,i);		  						MatRowPut(StockMov2r,rownr,StockMov2rw);		  						rownr = rownr + 1;  							end;  						end else begin	  						StockMov2rw.ArtCode = ORrw.ArtCode;	  						MatRowPut(StockMov2r,rownr,StockMov2rw);							if (!StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning)) then begin								res = 0;								goto LOut;							end;  							MatRowGet(StockMov2r,rownr,StockMov2rw);	  						StockMov2rw.Spec = ORrw.Spec;	  						StockMov2rw.OrdQuant = ORrw.Quant - itemqty;	  						StockMov2rw.Quant = ORrw.Quant - itemqty;	  						MatRowPut(StockMov2r,rownr,StockMov2rw);	  						if (!StockMovVc_PasteQuant(StockMov2r,rownr)) then begin	  							res = 0;								goto LOut;	  						end;	  						MatRowGet(StockMov2r,rownr,StockMov2rw);	  						//StockMov2rw.OldPrice = ORrw.BasePrice;		  					//StockMov2rw.NewPrice = ORrw.BasePrice;	  						StockMov2rw.ORRow = i;	  						//messagebox(0,i);		  					//logtext(0,i);	  						MatRowPut(StockMov2r,rownr,StockMov2rw);	  						rownr = rownr + 1;  						end;  					end;	  				end;  			end;  			if (rownr > 0) then begin  				StockMov2r.OrderNr = ORr.SerNr;  				StockMov2r.OrdTransDate = CurrentDate;  				StockMov2r.SerNr = NextSerNr("StockMovVc","",-1,false,"");  				StockMov2r.ToLocation = ORr.Location;  				StockMov2r.Comment = "Номер рахунка: " & ORr.SerNr & ". Клієнт: " & ORr.Addr0; //Edit***************************Sasha2,9:40 02.10.2014  				if (RECORDSTORE(StockMov2r,true)) then begin  					CreateRecordLink(ORr,company,StockMov2r,company);  					CreateRecordLink(StockMov2r,company,ORr,company);  				end;  			end;	  		end;  		  		res = rownr;	  	  LOut:;	RETURN;end; //Edit***************************Sasha2,15:00 26.08.2014 }global //Edit***************************Sasha2,15:00 26.08.2014 {updating procedure TakeFromShopsFromORVcRoutine(var record StockMovVc StockMov2r,record ORVc ORr,var integer res,integer company)BEGIN row ORVc ORrw; record StockMovVc StockMovr,StockMov3r; row StockMovVc StockMovrw, StockMov2rw,StockMov3rw; record INVc INr; record SHVc SHr; row SHVc SHrw; record RetVc Retr; row RetVc Retrw; integer rwcnt,i,rwcnt1,j,rownr,k,sercnt; val itemqty,remqty; Boolean TrHs,testf,printf; array string 255 aWarning; string 200 stmoves,ret; record ItemHistVc IHr;	if (ORr.OrderClass=="SHOPS") then begin				StockMovr.OrderNr = ORr.SerNr;		TrHs = true;		while(loopkey("OrderNr",StockMovr,1,TrHs)) begin			testf = true;			if(StockMovr.OrderNr!=ORr.SerNr)then begin testf = false; TrHs = false; end;			if(/*StockMovr.OrdFlag==0 or*/ StockMovr.OKFlag==0)then begin testf = false; end;			if(StockMovr.ToLocation!=ORr.Location)then begin testf = false; end;						if(testf)then begin				stmoves = stmoves & StockMovr.SerNr & ",";			end;		end;				Retr.OrdNr = ORr.SerNr;		TrHs = true;		while(loopkey("OrdNr",Retr,1,TrHs)) begin			testf = true;			if(Retr.OrdNr!=ORr.SerNr)then begin testf = false; TrHs = false; end;			if(Retr.OKFlag==0)then begin testf = false; end;			if(Retr.Location!=ORr.Location)then begin testf = false; end;						if(testf)then begin				ret = ret & Retr.SerNr & ",";			end;		end;		rwcnt = MatRowCnt(ORr);		for (i=0;i<rwcnt;i=i+1) begin			MatRowGet(ORr,i,ORrw);						itemqty = ORrw.Shopd; //Edit***************************Sasha2,11:17 16.11.2015			printf = false; //Edit***************************Sasha2,12:26 16.11.2015			TrHs = true; 			IHr.ArtCode = ORrw.ArtCode;			INr.Code = ORrw.ArtCode;			ReadFirstMain(INr,1,true);			while(loopkey("ActiveQty",IHr,1,TrHs)) begin				testf = true;				if(IHr.ArtCode!=ORrw.ArtCode)then begin TrHs = false; testf = false; end;				if(IHr.Location!=ORr.Location)then begin testf = false; end;				if (INr.SerNrf==0 and NonBlank(IHr.SerialNr)) then begin testf = false; end; //Edit***************************Sasha2,11:11 16.11.2015				if (INr.SerNrf>0 and Blank(IHr.SerialNr)) then begin testf = false; end; //Edit***************************Sasha2,11:11 16.11.2015				if (testf and INr.SerNrf>0) then begin //Edit***************************Sasha2,10:57 16.11.2015 {				  if(setinset(IHr.TransNr,stmoves)==false and setinset(IHr.TransNr,ret)==false)then begin testf = false; end; 				  if(IHr.FileName!="StockMovVc" and IHr.FileName!="RetVc")then begin testf = false; end;				end; //Edit***************************Sasha2,10:57 16.11.2015 }								if(testf)then begin				  if (INr.SerNrf>0) then begin				    testf = false;				    switch (IHr.FileName) begin    				  case "StockMovVc":    				    StockMovr.SerNr = IHr.TransNr;  				      if (ReadFirstMain(StockMovr,1,true)) then begin  				        MatRowGet(StockMovr,IHr.Row,StockMovrw);  				        if (StockMovrw.ORRow==i) then begin  				          testf = true;  				        end;  				      end;    				  case "RetVc":    				    Retr.SerNr = IHr.TransNr;  				      if (ReadFirstMain(Retr,1,true)) then begin  				        MatRowGet(Retr,IHr.Row,Retrw);  				        if (Retrw.OrdRow==i) then begin  				          testf = true;  				        end;  				      end;  				  end;  				  if (testf) then begin //Edit***************************Sasha2,11:22 16.11.2015 {  				    remqty = IHr.RemQty;  				  end; //Edit***************************Sasha2,11:22 16.11.2015 }				  end else begin				    testf = false;				    if (IHr.RemQty > itemqty) then begin //Edit***************************Sasha2,11:22 16.11.2015				      remqty = remqty + itemqty;				      TrHs = false;				      testf = true;				    end else begin				      remqty = remqty + IHr.RemQty;				    end;				    itemqty = itemqty - IHr.RemQty;				  end;  			end;				if(testf and remqty>0)then begin					StockMov2rw.ArtCode = IHr.ArtCode;					MatRowPut(StockMov2r,rownr,StockMov2rw);					StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning);					MatRowGet(StockMov2r,rownr,StockMov2rw);					StockMov2rw.Spec = ORrw.Spec;					StockMov2rw.OrdQuant = remqty;					StockMov2rw.Quant = remqty;					MatRowPut(StockMov2r,rownr,StockMov2rw);					StockMovVc_PasteQuant(StockMov2r,rownr);					MatRowGet(StockMov2r,rownr,StockMov2rw);					if (INr.SerNrf>0) then begin  					StockMov2rw.SerialNr = IHr.SerialNr;  					MatRowPut(StockMov2r,rownr,StockMov2rw);  					StockMovVc_PasteSerialNr(StockMov2r,rownr,aWarning);  					MatRowGet(StockMov2r,rownr,StockMov2rw);					end;					//StockMov2rw.OldPrice = ORrw.BasePrice;//???					//StockMov2rw.NewPrice = ORrw.BasePrice;//???					StockMov2rw.ORRow = i;					MatRowPut(StockMov2r,rownr,StockMov2rw);					rownr = rownr + 1;					remqty = 0;					printf = true;				end;			end; resetloop(IHr);						if (INr.SerNrf==0 and remqty>0 and printf==false) then begin //Edit***************************Sasha2,12:24 16.11.2015 {			  StockMov2rw.ArtCode = INr.Code;				MatRowPut(StockMov2r,rownr,StockMov2rw);				StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning);				MatRowGet(StockMov2r,rownr,StockMov2rw);				StockMov2rw.Spec = ORrw.Spec;				StockMov2rw.OrdQuant = remqty;				StockMov2rw.Quant = remqty;				MatRowPut(StockMov2r,rownr,StockMov2rw);				StockMovVc_PasteQuant(StockMov2r,rownr);				MatRowGet(StockMov2r,rownr,StockMov2rw);				StockMov2rw.ORRow = i;				MatRowPut(StockMov2r,rownr,StockMov2rw);				rownr = rownr + 1;				remqty = 0;			end; //Edit***************************Sasha2,12:28 16.11.2015 }					end;			if(rownr>0)then begin			StockMov2r.OrderNr = ORr.SerNr;			StockMov2r.OrdTransDate = CurrentDate;			StockMov2r.SerNr = NextSerNr("StockMovVc","",-1,false,"");			StockMov2r.FrLocation = ORr.Location;			if (RECORDSTORE(StockMov2r,true)) then begin				CreateRecordLink(ORr,company,StockMov2r,company);				CreateRecordLink(StockMov2r,company,ORr,company);			end;		end;		res = rownr;				end;	/*rownr = 0;	if (ORr.OrderClass=="Shops") then begin		rwcnt = MatRowCnt(ORr);		RECORDNEW(StockMov3r);		StockMovr.OrderNr = ORr.SerNr;		if (ReadFirstKey("OrderNr",StockMovr,1,true)) then begin			for (i=0;i<rwcnt;i=i+1) begin				MatRowGet(ORr,i,ORrw);				if ((ORrw.Quant - ORrw.Shipd2) > 0 and NonBlank(ORrw.ArtCode)) then begin					itemqty = 0;					while (LoopKey("OrderNr",StockMovr,1,true)) begin						if (StockMovr.OKFlag==1 and StockMovr.OrderNr==ORr.SerNr) then begin  						rwcnt1=MatRowCnt(StockMovr);  						for (j=0;j<rwcnt1;j=j+1) begin  							MatRowGet(StockMovr,j,StockMovrw);								testf = true;								if (StockMovrw.ArtCode!=ORrw.ArtCode or StockMovrw.ORRow!=i) then begin testf = false; end;								if (testf) then begin									if (StockMovr.ToLocation==ORr.Location) then begin		  							itemqty = itemqty + StockMovrw.Quant;		  							if (NonBlank(StockMovrw.SerialNr)) then begin		  								CollectSerials(StockMov3r,StockMovrw.ArtCode,StockMovrw.SerialNr,1);		  							end;		  						end;		  						if (StockMovr.FrLocation==ORr.Location) then begin		  							itemqty = itemqty - StockMovrw.Quant;		  							if (NonBlank(StockMovrw.SerialNr)) then begin		  								CollectSerials(StockMov3r,StockMovrw.ArtCode,StockMovrw.SerialNr,-1);		  							end;		  						end; 							  end;							end;						end;					end; RESETLOOP(StockMovr);										SHr.OrderNr = ORr.SerNr;					TrHs = true;					while (LoopKey("OrderKey",SHr,1,TrHs)) begin						if (SHr.OKFlag==1 and SHr.OrderNr==ORr.SerNr) then begin							rwcnt1=MatRowCnt(SHr);							for (j=0;j<rwcnt1;j=j+1) begin								MatRowGet(SHr,j,SHrw);								testf = true;								if (SHrw.ArtCode!=ORrw.ArtCode or SHrw.OrdRow!=i) then begin testf = false; end;								if (testf) then begin		  						itemqty = itemqty - SHrw.Ship;		  						if (NonBlank(SHrw.SerialNr)) then begin	  								CollectSerials(StockMov3r,StockMovrw.ArtCode,SHrw.SerialNr,-1);	  							end; 								end;							end;						end;					end; RESETLOOP(SHr);										Retr.OrdNr = ORr.SerNr;					TrHs = true;					while (LoopKey("OrdNr",Retr,1,TrHs)) begin						if (Retr.OKFlag==1 and Retr.OrdNr==ORr.SerNr and Retr.Location==ORr.Location) then begin							rwcnt1=MatRowCnt(Retr);							for (j=0;j<rwcnt1;j=j+1) begin								MatRowGet(Retr,j,Retrw);								testf = true;								if (Retrw.ArtCode!=ORrw.ArtCode or Retrw.OrdRow!=i) then begin testf = false; end;								if (testf) then begin		  						itemqty = itemqty + Retrw.Quant;		  						if (NonBlank(Retrw.SerialNr)) then begin	  								CollectSerials(StockMov3r,StockMovrw.ArtCode,Retrw.SerialNr,1);	  							end;								end;							end;						end;					end; RESETLOOP(Retr);	  										if (itemqty > 0) then begin						INr.Code = ORrw.ArtCode;						ReadFirstMain(INr,1,true);						if (INr.SerNrf == 1) then begin							sercnt = MatRowCnt(StockMov3r);							for (k=0;k<sercnt;k=k+1) begin								MatRowGet(StockMov3r,k,StockMov3rw);								if (StockMov3rw.ArtCode==ORrw.ArtCode and StockMov3rw.Quant>0) then begin			  						StockMov2rw.ArtCode = ORrw.ArtCode;		  						MatRowPut(StockMov2r,rownr,StockMov2rw);  								if (!StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning)) then begin  									res = 0;  									goto LOut;  								end;  								MatRowGet(StockMov2r,rownr,StockMov2rw);		  						StockMov2rw.Spec = ORrw.Spec;		  						StockMov2rw.OrdQuant = 1;		  						StockMov2rw.Quant = 1;		  						MatRowPut(StockMov2r,rownr,StockMov2rw);		  						if (!StockMovVc_PasteQuant(StockMovr,rownr)) then begin		  							res = 0;  									goto LOut;		  						end;		  						MatRowGet(StockMov2r,rownr,StockMov2rw);		  						StockMov2rw.SerialNr = StockMov3rw.SerialNr;		  						MatRowPut(StockMov2r,rownr,StockMov2rw);		  						StockMovVc_PasteSerialNr(StockMov2r,rownr,aWarning);		  						MatRowGet(StockMov2r,rownr,StockMov2rw);		  						//StockMov2rw.OldPrice = ORrw.BasePrice;//???				  				//StockMov2rw.NewPrice = ORrw.BasePrice;//???		  						StockMov2rw.ORRow = i;		  						MatRowPut(StockMov2r,rownr,StockMov2rw);		  						rownr = rownr + 1;		  					end;	  					end;	  					end else begin  						StockMov2rw.ArtCode = ORrw.ArtCode;  						MatRowPut(StockMov2r,rownr,StockMov2rw);							if (!StockMovVc_PasteArtCode(StockMov2r,rownr,1,aWarning)) then begin								res = 0;								goto LOut;							end;							MatRowGet(StockMov2r,rownr,StockMov2rw);  						StockMov2rw.Spec = ORrw.Spec;  						StockMov2rw.OrdQuant = itemqty;  						StockMov2rw.Quant = itemqty;  						MatRowPut(StockMov2r,rownr,StockMov2rw);  						if (!StockMovVc_PasteQuant(StockMovr,rownr)) then begin  							res = 0;								goto LOut;  						end;  						MatRowGet(StockMov2r,rownr,StockMov2rw);  						StockMov2rw.SerialNr = "";  						//StockMov2rw.OldPrice = ORrw.BasePrice;//???		  				//StockMov2rw.NewPrice = ORrw.BasePrice;//???  						StockMov2rw.ORRow = i;  						MatRowPut(StockMov2r,rownr,StockMov2rw);  						rownr = rownr + 1;  					end;						end;					end;				end;		end;				if (rownr > 0) then begin			StockMov2r.OrderNr = ORr.SerNr;			StockMov2r.OrdTransDate = CurrentDate;			StockMov2r.SerNr = NextSerNr("StockMovVc","",-1,false,"");			StockMov2r.FrLocation = ORr.Location;			if (RECORDSTORE(StockMov2r,true)) then begin				CreateRecordLink(ORr,company,StockMov2r,company);				CreateRecordLink(StockMov2r,company,ORr,company);			end;		end;		end;			res = rownr;  Lout:;*/RETURN;end;global //Edit***************************Sasha2,11:35 23.07.2015 {updating procedure HandleSplitSerialItemsORVc(var record ORVc ORr,integer rwcnt,var string warning)BEGIN  record ORVc OR2r;  record INVc INr;  row ORVc ORrw;  integer i,j,curpos;  val qty;  Boolean chsum,recalcSumup;  record ModuleBlock OptFeature;     BlockLoad(OptFeature);    RecordCopy(OR2r,ORr);  	for (i=(rwcnt - 1);i>=0;i=i-1) begin  	  MatRowGet(ORr,i,ORrw);  	  if (ORrw.Shipd1>0 or ORrw.Invd>0 or ORrw.Shopd>0) then begin  	    warning = "Order has attached documents";  	    goto LHandleSplitSerialItemsORVc;  	  end;  	  MatRowDelete(ORr,i);  	end;  	curpos = 0;  	for (i=0;i<rwcnt;i=i+1) begin  	  MatRowGet(OR2r,i,ORrw);  	  if (NonBlank(ORrw.ArtCode)) then begin  	    INr.Code = ORrw.ArtCode;  	    ReadFirstMain(INr,1,true);  	    if (INr.SerNrf>0) then begin  	      qty = ORrw.Quant;  	      if (qty<0) then begin  	        warning = USetStr(1574);  	        goto LHandleSplitSerialItemsORVc;  	      end;  	      for (j=0;j<qty;j=j+1) begin  	        chsum = false;  	        ORrw.Quant = 1;  	        MatRowPut(ORr,curpos,ORrw);  	        if (OptFeature.NoQtyDepPrices==0) then begin              ORVc_PasteQuant(ORr,curpos,true,chsum);            end else begin              chsum = ORDchrsum(ORr,curpos);            end;            if (chsum) then begin              ORDchsum(ORr,curpos);              recalcSumup = true;            end;  	        curpos = curpos + 1;  	      end;  	    end else begin  	      MatRowPut(ORr,curpos,ORrw);  	      curpos = curpos + 1;  	    end;  	  end else begin  	    MatRowPut(ORr,curpos,ORrw);  	    curpos = curpos + 1;  	  end;  	end;  	if (recalcSumup) then begin  	  ORSumup(ORr);  	end;  	  	if (!RECORDSTORE(ORr,true)) then begin  	  warning = "Problem to save record";  	end;  	  LHandleSplitSerialItemsORVc:;	 RETURN;end; //Edit***************************Sasha2,11:35 23.07.2015 }